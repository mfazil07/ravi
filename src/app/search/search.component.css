<script>
function waitForMultiselectReady(selector, callback, attempts = 20) {
    if (attempts <= 0) return;
    var $sel = $(selector);
    if ($sel.data('multiselect') && $sel.find('option').length > 0) {
        callback($sel);
    } else {
        setTimeout(function() {
            waitForMultiselectReady(selector, callback, attempts - 1);
        }, 100);
    }
}

$(document).ready(function () {
    var selectedCountries = @Html.Raw(Json.Serialize(Model.Country ?? new List<string>()));
    if (selectedCountries && !Array.isArray(selectedCountries)) selectedCountries = [selectedCountries];
    var selectedStates = @Html.Raw(Json.Serialize(Model.State ?? new List<string>()));
    if (selectedStates && !Array.isArray(selectedStates)) selectedStates = [selectedStates];

    $('#@idDDCountry').multiselect({
        includeSelectAllOption: true,
        enableFiltering: true,
        enableCaseInsensitiveFiltering: true,
        buttonWidth: '100%',
        maxHeight: 300,
        buttonClass: 'form-control text-left',
        nonSelectedText: '- Select Country -',
        selectAllText: 'Select All',
        allSelectedText: 'All Selected',
        nSelectedText: 'Selected',
        templates: {
            filter: '<li class="multiselect-item multiselect-filter"><div class="input-group"><span class="input-group-addon"><i class="fa fa-search"></i></span><input class="form-control multiselect-search" type="text"></div></li>',
            filterClearBtn: '<span class="input-group-btn"><button class="btn btn-default multiselect-clear-filter" type="button"><i class="fa fa-times"></i></button></span>'
        }
    });

    $('#@idDDState').multiselect({
        includeSelectAllOption: true,
        enableFiltering: true,
        enableCaseInsensitiveFiltering: true,
        buttonWidth: '100%',
        maxHeight: 300,
        buttonClass: 'form-control text-left',
        nonSelectedText: '- Select State -',
        selectAllText: 'Select All',
        allSelectedText: 'All Selected',
        nSelectedText: 'Selected'
    });

    waitForMultiselectReady('#@idDDCountry', function($sel) {
        $sel.multiselect('select', selectedCountries);
    });

    waitForMultiselectReady('#@idDDState', function($sel) {
        $sel.multiselect('select', selectedStates);
    });

    // ...rest of your logic...
});
</script>
