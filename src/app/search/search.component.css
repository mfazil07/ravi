@model Qtc.PartnerPortal.WebApp.Models.CancelReschWeatherAlertViewModel

@{    
    var idDDCountry = $"ddl{Model.Section}ApptCountry";
    var idDDState = $"ddl{Model.Section}ApptState";
    var idDDWeatherEvent = $"ddl{Model.Section}WeatherEvent";
}

<!-- Weather Alerts -->
<div class="row mt-3 mb-2">
    <div class="row justify-content-between">
        <div class="col-3 p-2 h6 darkpurpleText">
            <span class="fa-stack">
                <i class="fa fa-circle-thin fa-stack-2x text-primary"></i>
                <i class="fa fa-cloud fa-stack-1x text-black"></i>
                <i class="fa fa-bolt fa-stack-1x text-danger mt-1"></i>
            </span>
            <b> Weather Alerts</b>
        </div>
    </div>

    <div class="col-md-5">
        <label title="Filter weather events by the Country" for="@idDDCountry">Weather Alert Countries</label>
        <span class="text-danger">*</span>
        <div class="form-group">
            <select id="@idDDCountry" name="Country" multiple="multiple" class="form-control mb-2 qtc-weather-alert-multi-select">
                @foreach (var item in Model.CountryList)
                {
                    <option value="@item.Key" selected="@(Model.Country != null && Model.Country.Contains(item.Key) ? "selected" : null)">
                        @item.Value
                    </option>
                }
            </select>
            <div class="validationError divInvalidCountry text-danger" style="display:none">
                <span class="field-validation-error" data-valmsg-for="Country" data-valmsg-replace="true">
                    Please select at least one country.
                </span>
            </div>
        </div>
    </div>
    <div class="col-md-5">       
        <div class="form-group">
            <label title="Filter weather events by the State (US)" for="@idDDState">Weather Alert States (US)</label>
            <select class="form-control mb-2 qtc-weather-alert-multi-select" id="@idDDState" name="States" placeholder="- Select State -" multiple="multiple">
                @foreach (var item in Model.StatesList)
                {
                    <option value="@item.Key" selected="@(Model.State != null && Model.State.Contains(item.Key) ? "selected" : null)">
                        @item.Value
                    </option>
                }
            </select>
        </div>
    </div>
    <div class="col-md-12 mt-3">
        <label title="Select the weather event affected the reschedule" for="idDDWeatherEvent">Weather Alert</label>
        <div class="form-group">
            <select class="form-control" id="@idDDWeatherEvent" name="Weather Alerts" placeholder="- Select Weather Alert -">
                @* @foreach (var item in Model.WeatherEventList) *@
                @* { *@
                @*     <option value="@item.WeatherEventId"> *@
                @*         Event: @item.WeatherEvent, Type: @item.WeatherType, Description: @item.Description [ @item.StartDate.ToShortDateString() -  @item.EndDate.ToShortDateString() ] *@
                @*     </option> *@
                @* } *@
            </select>
        </div>
    </div>
</div>

<script>
    function updateWeatherEventsDropdown(events) {
        var $dropdown = $("#ddlRescheduleWeatherEvent");
        $dropdown.empty();
        $dropdown.append('<option value="">- Select Weather Alert -</option>');
        if (events && events.length) {
            events.forEach(function (event) {
                var text = "Event: " + event.WeatherEventName + ", Type: " + event.Reason +
                    ", Description: " + event.Description +
                    " [" + event.StartDate + " - " + event.EndDate + "]";
                $dropdown.append('<option value="' + event.WeatherEventId + '">' + text + '</option>');
            });
        }
    }

    $(document).ready(function () {
        // Initialize multiselects
        function initializeMultiSelects() {
            $('#@idDDCountry').multiselect({
                includeSelectAllOption: true,
                enableFiltering: true,
                enableCaseInsensitiveFiltering: true,
                buttonWidth: '100%',
                maxHeight: 300,
                buttonClass: 'form-control text-left',
                templates: {
                    filter: '<li class="multiselect-item multiselect-filter"><div class="input-group"><span class="input-group-addon"><i class="fa fa-search"></i></span><input class="form-control multiselect-search" type="text"></div></li>',
                    filterClearBtn: '<span class="input-group-btn"><button class="btn btn-default multiselect-clear-filter" type="button"><i class="fa fa-times"></i></button></span>'
                },
                onInitialized: function(select, container) {
                    var selectedCountries = @Html.Raw(Json.Serialize(Model.Country ?? new List<string>()));
                    if (selectedCountries && selectedCountries.length > 0) {
                        $(select).val(selectedCountries);
                        $(select).multiselect('refresh');
                    }
                }
            });

            $('#@idDDState').multiselect({
                includeSelectAllOption: true,
                enableFiltering: true,
                buttonWidth: '100%',
                buttonClass: 'form-control text-left',
                onInitialized: function(select, container) {
                    var selectedStates = @Html.Raw(Json.Serialize(Model.State ?? new List<string>()));
                    if (selectedStates && selectedStates.length > 0) {
                        $(select).val(selectedStates);
                        $(select).multiselect('refresh');
                    }
                }
            });
        }

        // Initialize the multiselect dropdowns
        initializeMultiSelects();

        function toggleWeatherAlerts() {
            var requestedByText = $("#ddlRequestedBy option:selected").text();
            var rescheduleReasonText = $("#ddlRescheduleReason option:selected").text();

            if (requestedByText === "EXAMINEE" && rescheduleReasonText === "Appointment rescheduled per weather event") {
                $("#weatherAlertsSection").show();
                // Refresh multiselects to ensure proper rendering
                $('#@idDDCountry').multiselect('refresh');
                $('#@idDDState').multiselect('refresh');
            } else {
                $("#weatherAlertsSection").hide();
                // Clear selections
                $('#@idDDState').multiselect('deselectAll', false);
                $('#@idDDState').multiselect('updateButtonText');
                $('#@idDDCountry').multiselect('deselectAll', false);
                $('#@idDDCountry').multiselect('updateButtonText');
                $("#ddlRescheduleWeatherEvent").val(null).trigger("change");
            }
        }

        // Bind the change event to dropdowns
        $("#ddlRequestedBy, #ddlRescheduleReason").on("change", function () {
            toggleWeatherAlerts();
        });

        // Run the function on page load to set the correct visibility
        toggleWeatherAlerts();

        // state checkboxes click event inside multi-select dropdown
        $("#ddlRescheduleApptState").next(".btn-group").find("input").on("click", function () {
            triggerWeatherEventsCheck();
        });

        $("#ddlRescheduleApptCountry").on("change", function () {
            triggerWeatherEventsCheck();

            var selectedCountries = $(this).val();
            if (selectedCountries && selectedCountries.includes("USA")) {
                $("#ddlRescheduleApptState").closest(".form-group").show();
            } else {
                $("#ddlRescheduleApptState").closest(".form-group").hide();
                $("#ddlRescheduleApptState").val([]).trigger("change");
            }
        });

        // state dropdown is hidden initially if USA is not selected
        var initialCountries = $("#ddlreschApptCountry").val();
        if (!initialCountries || !initialCountries.includes("USA")) {
            $("#ddlRescheduleApptState").closest(".form-group").hide();
        }

        function triggerWeatherEventsCheck() {
            setTimeout(function () {
                // Gather selections
                var selectedStates = [];
                $("#ddlRescheduleApptState").next(".btn-group").find("input:checked").each(function () {
                    selectedStates.push($(this).val());
                });
                var selectedCountries = $("#ddlRescheduleApptCountry").val();

                // Handle USA: States must be selected
                if (selectedCountries && selectedCountries.includes("USA")) {
                    if (selectedStates.length === 0) {
                        updateWeatherEventsDropdown([]);
                        return;
                    }
                }

                // If no country selected at all, clear weather events
                if (!selectedCountries || selectedCountries.length === 0) {
                    updateWeatherEventsDropdown([]);
                    return;
                }

                // If another country (not USA), proceed with AJAX (states irrelevant)
                var data = {
                    Country: selectedCountries,
                    State: selectedStates.length > 0 ? selectedStates : null
                };

                $.ajax({
                    url: "/RescheduleReason/GetWeatherEvents",
                    type: "POST",
                    data: JSON.stringify(data),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    processData: false,
                    success: function (response) {
                        updateWeatherEventsDropdown(response);
                    },
                    error: function (xhr, status, error) {
                        console.error("Error fetching weather events:", error);
                    }
                });
            }, 100);
        }
    });
</script>
