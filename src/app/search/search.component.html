import { ComponentFixture, TestBed, fakeAsync, tick } from '@angular/core/testing';
import { QtcHeaderComponent } from './qtc-header.component';
import { CommonService } from '../services/common.service';
import { Router, NavigationEnd } from '@angular/router';
import { of, Subject } from 'rxjs';
import { By } from '@angular/platform-browser';
import { ClarityModule } from '@clr/angular';

class MockRouter {
  public events = new Subject<any>();
  navigate() {}
  serializeUrl() {
    return '/withAppointment';
  }
  createUrlTree() {
    return {};
  }
}

describe('QtcHeaderComponent', () => {
  let component: QtcHeaderComponent;
  let fixture: ComponentFixture<QtcHeaderComponent>;
  let mockCommonService: jasmine.SpyObj<CommonService>;
  let mockRouter: MockRouter;
  let sessionStorageSpy: jasmine.Spy;

  beforeEach(async () => {
    // Create a mock for the CommonService
    mockCommonService = jasmine.createSpyObj('CommonService', ['getReferrerUrl'], {
      userName$: of('TestUser'),
      currentFlag: of(true),
      currentAppointmentsFlag: of(false),
      claimantIdSubject$: of(123),
      caseIdSubject$: of(456)
    });

    // Mock sessionStorage
    let store: { [key: string]: string } = {};
    sessionStorageSpy = spyOn(sessionStorage, 'getItem').and.callFake((key: string) => {
      return store[key] || null;
    });
    spyOn(sessionStorage, 'setItem').and.callFake((key: string, value: string) => {
      store[key] = value;
    });
    spyOn(sessionStorage, 'removeItem').and.callFake((key: string) => {
      delete store[key];
    });
    spyOn(sessionStorage, 'clear').and.callFake(() => {
      store = {};
    });

    // Set the referrer URL
    mockCommonService.getReferrerUrl.and.returnValue('http://example.com/');

    // Create a mock for the Router
    mockRouter = new MockRouter();

    await TestBed.configureTestingModule({
      declarations: [QtcHeaderComponent],
      imports: [ClarityModule],
      providers: [
        { provide: CommonService, useValue: mockCommonService },
        { provide: Router, useValue: mockRouter }
      ],
    }).compileComponents();
  });

  beforeEach(() => {
    fixture = TestBed.createComponent(QtcHeaderComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });

  it('should display the userName initially from the CommonService', () => {
    expect(component.userName).toBe('TESTUSER');
    const userNameElement = fixture.debugElement.query(By.css('.user-icon-text'));
    expect(userNameElement.nativeElement.textContent).toContain('TESTUSER');
  });

  it('should update notesRequired from the CommonService', () => {
    expect(component.notesRequired).toBeTrue();
  });

  it('should update appointmentsIconRequired from the CommonService', () => {
    expect(component.appointmentsIconRequired).toBeFalse();
  });

  it('should update claimantId and caseId from the CommonService', () => {
    expect(component.claimantId).toBe(123);
    expect(component.caseId).toBe(456);
  });

  it('should set externalUrl and sessionStorage on initialization', () => {
    // Verify the externalUrl was set correctly
    expect(component.externalUrl).toBe('http://example.com/');
    
    // Verify sessionStorage was set correctly
    expect(sessionStorage.setItem).toHaveBeenCalledWith(
      'notesDocumentReferrer', 
      'http://example.com/'
    );
    
    // Verify getReferrerUrl was called
    expect(mockCommonService.getReferrerUrl).toHaveBeenCalled();
  });

  it('should update claimantLevel on navigation events', fakeAsync(() => {
    mockRouter.events.next(new NavigationEnd(0, '/withAppointment', '/withAppointment'));
    tick();
    fixture.detectChanges();
    expect(component.claimantLevel).toBe(' - APPOINTMENT LEVEL');

    mockRouter.events.next(new NavigationEnd(0, '/search', '/search'));
    tick();
    fixture.detectChanges();
    expect(component.claimantLevel).toBe(' - CASE LEVEL');

    mockRouter.events.next(new NavigationEnd(0, '/notAuthorized', '/notAuthorized'));
    tick();
    fixture.detectChanges();
    expect(component.claimantLevel).toBe('');
  }));

  it('should open notes window with correct URL', () => {
    spyOn(window, 'open');
    component.openNotesWindow();
    expect(window.open).toHaveBeenCalledWith(
      'http://example.com/notes/Q_NOTES_01.asp?claimant_Id=123&case_Id=456',
      'Notes',
      'toolbar=no, scrollbars=yes, resizable=yes, top=100, left=100, width=900, height=800'
    );
  });

  it('should open appointments window with correct URL', () => {
    spyOn(window, 'open');
    component.openAppointmentsWindow();
    expect(window.open).toHaveBeenCalledWith(
      `${window.location.origin}/withAppointment`,
      'AppointmentLevel',
      'toolbar=no, scrollbars=yes, resizable=yes, top=100, left=100, width=1200, height=800'
    );
  });
});
