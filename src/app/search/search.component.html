import { ComponentFixture, TestBed } from '@angular/core/testing';
import { HttpClientModule, HttpErrorResponse } from '@angular/common/http';
import { SearchComponent } from '../search/search.component';
import { FormsModule, NgModel } from '@angular/forms';
import { ClrComboboxModule, ClrDatagridModule, ClrDatalistModule, ClrDataModule, ClrDatepickerModule, ClrInputModule, ClrModalModule } from '@clr/angular';
import { AddeventComponent } from '../addevent/addevent.component';
import { CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';
import { CommonService } from '../services/common.service';
import { of } from 'rxjs';
import { ActivatedRoute } from '@angular/router';
import { HttpClientTestingModule } from '@angular/common/http/testing';
import { formatDate } from '@angular/common';
import { AlertService, IAlertType } from '../services/alert.service';

describe('AddeventComponent', () => {
  let component: AddeventComponent;
  let fixture: ComponentFixture<AddeventComponent>;
  let commonService: jasmine.SpyObj<CommonService>;
  let alertService: jasmine.SpyObj<AlertService>;
  
  // Mock elements for ComboBoxRef
  const mockCountryElement = {
    setAttribute: jasmine.createSpy('setAttribute')
  };
  const mockStateElement = {
    setAttribute: jasmine.createSpy('setAttribute')
  };

  const activatedRouteMock = {
    queryParams: of({ userName: 'RBALANZ' }),
  };

  beforeEach(async () => {
    const commonServiceSpy = jasmine.createSpyObj('CommonService', [
      'getUserAuthorization',
      'getallCountries',
      'getUsStates',
      'getAllWeatherTypes',
      'addWeatherEvent',
    ]);

    const alertServiceSpy = jasmine.createSpyObj('AlertService', ['show']);
    const searchComponentSpy = jasmine.createSpyObj('SearchComponent', ['refreshWeatherEvents']);
    const formSpy = jasmine.createSpyObj('form', ['get', 'enable']);

    await TestBed.configureTestingModule({
      declarations: [SearchComponent, AddeventComponent],
      imports: [
        HttpClientModule,
        FormsModule,
        ClrComboboxModule,
        ClrDatalistModule,
        ClrDatepickerModule,
        ClrInputModule,
        ClrDatagridModule,
        ClrDataModule,
        ClrModalModule,
        HttpClientTestingModule,
      ],
      providers: [
        { provide: CommonService, useValue: commonServiceSpy },
        { provide: AlertService, useValue: alertServiceSpy },
        { provide: ActivatedRoute, useValue: activatedRouteMock },
        { provide: SearchComponent, useValue: searchComponentSpy },
      ],
      schemas: [CUSTOM_ELEMENTS_SCHEMA],
    }).compileComponents();

    fixture = TestBed.createComponent(AddeventComponent);
    component = fixture.componentInstance;

    // Initialize ComboBoxRef with proper mocks
    component.addEventCountryComboBoxRef = {
      nativeElement: {
        querySelector: jasmine.createSpy('querySelector').and.callFake((selector: string) => {
          return selector.includes('USA') ? mockCountryElement : null;
        })
      }
    } as any;

    component.addEventStateComboBoxRef = {
      nativeElement: {
        querySelector: jasmine.createSpy('querySelector').and.callFake((selector: string) => {
          return selector.includes('CA') ? mockStateElement : null;
        })
      }
    } as any;

    commonService = TestBed.inject(CommonService) as jasmine.SpyObj<CommonService>;
    alertService = TestBed.inject(AlertService) as jasmine.SpyObj<AlertService>;

    // Mock service methods with correct return types
    commonService.getUserAuthorization.and.returnValue(of(['authorizedUser']));
    commonService.getallCountries.and.returnValue(
      of([
        { countryCode: 'US', countryName: 'United States', key: 'USA', value: 'United States' },
        { countryCode: 'CA', countryName: 'Canada', key: 'Canada', value: 'Canada' },
      ])
    );

    commonService.getUsStates.and.returnValue(
      of([
        { countryCode: 'CA', countryName: 'California', key: 'California', value: 'CA' },
        { countryCode: 'TX', countryName: 'Texas', key: 'Texas', value: 'TX' },
      ])
    );

    commonService.getAllWeatherTypes.and.returnValue(
      of([{ weatherTypeCode: 'HURR', weatherName: 'Hurricane', key: 'Hurricane', value: 'Hurricane' }])
    );

    commonService.addWeatherEvent.and.returnValue(
      of({ success: true })
    );

    component.weatheraddform = { form: formSpy } as any;

    fixture.detectChanges();
  });

  afterEach(() => {
    // Clear all spies
    mockCountryElement.setAttribute.calls.reset();
    mockStateElement.setAttribute.calls.reset();
  });

  it('should create Add Event component', () => {
    expect(component).toBeTruthy();
  });

  it('should call required services on init', () => {
    component.ngOnInit();
    expect(commonService.getUserAuthorization).toHaveBeenCalled();
    expect(commonService.getallCountries).toHaveBeenCalled();
    expect(commonService.getAllWeatherTypes).toHaveBeenCalled();
  });

  // Add other specific test cases as required and adjust types accordingly.
});
