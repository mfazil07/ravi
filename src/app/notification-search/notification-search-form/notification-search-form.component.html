describe('countryStateChange', () => {
  let mockClaimantsWeatherAlertsService: any;

  beforeEach(() => {
    // Create a mock service
    mockClaimantsWeatherAlertsService = {
      getClaimantInfo: jasmine.createSpy('getClaimantInfo').and.returnValue(
        of({
          country: 'USA',
          state: 'CA',
          mappedCountries: ['USA', 'CAN'],
          mappedStates: ['CA', 'TX']
        })
      )
    };

    // Provide the mock service
    TestBed.configureTestingModule({
      providers: [
        {
          provide: 'ClaimantsWeatherAlertsService',
          useValue: mockClaimantsWeatherAlertsService
        }
      ]
    });

    component.claimantId = 'testClaimant';
    component.caseId = 'testCase';
    component.notificationSearch = {
      mappedEvents: false,
      frmSrchCountry: [],
      frmSrchState: []
    };
    component.countries = [
      { key: 'USA', value: 'United States' },
      { key: 'CAN', value: 'Canada' }
    ];
  });

  it('should call getClaimantInfo with correct parameters', () => {
    component.countryStateChange();
    expect(mockClaimantsWeatherAlertsService.getClaimantInfo).toHaveBeenCalledWith(
      'testClaimant',
      'testCase',
      false
    );
  });

  it('should update caseDetails with the response data', () => {
    component.countryStateChange();
    expect(component.caseDetails).toEqual({
      country: 'USA',
      state: 'CA',
      mappedCountries: ['USA', 'CAN'],
      mappedStates: ['CA', 'TX']
    });
  });

  it('should update claimantResidentCountry with case country and mapped countries', () => {
    component.countryStateChange();
    expect(component.claimantResidentCountry).toEqual([
      { key: 'USA', value: 'USA' },
      { key: 'CAN', value: 'CAN' }
    ]);
  });

  it('should update countriesComboboxData with country values', () => {
    component.countryStateChange();
    expect(component.countriesComboboxData).toEqual([
      { key: 'USA', value: 'United States' },
      { key: 'CAN', value: 'Canada' }
    ]);
  });

  it('should update notificationSearch.frmSrchCountry with countriesComboboxData', () => {
    component.countryStateChange();
    expect(component.notificationSearch.frmSrchCountry).toEqual([
      { key: 'USA', value: 'United States' },
      { key: 'CAN', value: 'Canada' }
    ]);
  });

  it('should update states when country is USA', () => {
    component.countryStateChange();
    expect(component.states).toEqual([
      { key: 'CA', value: 'CA' },
      { key: 'TX', value: 'TX' }
    ]);
  });

  it('should update notificationSearch.frmSrchState with states when country is USA', () => {
    component.countryStateChange();
    expect(component.notificationSearch.frmSrchState).toEqual([
      { key: 'CA', value: 'CA' },
      { key: 'TX', value: 'TX' }
    ]);
  });

  it('should set isUSAExist to true when USA is in countriesComboboxData', () => {
    component.countryStateChange();
    expect(component.isUSAExist).toBeTrue();
  });

  it('should not update states when country is not USA', () => {
    mockClaimantsWeatherAlertsService.getClaimantInfo.and.returnValue(
      of({
        country: 'CAN',
        mappedCountries: ['CAN'],
        mappedStates: []
      })
    );
    component.countryStateChange();
    expect(component.states).toEqual([]);
    expect(component.notificationSearch.frmSrchState).toEqual([]);
    expect(component.isUSAExist).toBeFalse();
  });

  it('should handle error response', () => {
    const errorResponse = new HttpErrorResponse({
      error: 'test 404 error',
      status: 404,
      statusText: 'Not Found'
    });
    
    mockClaimantsWeatherAlertsService.getClaimantInfo.and.returnValue(
      throwError(() => errorResponse)
    );
    
    spyOn(component, 'handleError');
    component.countryStateChange();
    
    expect(component.handleError).toHaveBeenCalledWith(errorResponse);
  });

  it('should not add duplicate countries to claimantResidentCountry', () => {
    mockClaimantsWeatherAlertsService.getClaimantInfo.and.returnValue(
      of({
        country: 'USA',
        mappedCountries: ['USA'], // duplicate
        mappedStates: []
      })
    );
    
    component.countryStateChange();
    expect(component.claimantResidentCountry).toEqual([
      { key: 'USA', value: 'USA' }
    ]);
  });

  it('should not add duplicate states', () => {
    mockClaimantsWeatherAlertsService.getClaimantInfo.and.returnValue(
      of({
        country: 'USA',
        state: 'CA',
        mappedCountries: ['USA'],
        mappedStates: ['CA'] // duplicate
      })
    );
    
    component.countryStateChange();
    expect(component.states).toEqual([
      { key: 'CA', value: 'CA' }
    ]);
  });

  it('should handle empty mappedCountries', () => {
    mockClaimantsWeatherAlertsService.getClaimantInfo.and.returnValue(
      of({
        country: 'USA',
        mappedCountries: null,
        mappedStates: []
      })
    );
    
    component.countryStateChange();
    expect(component.claimantResidentCountry).toEqual([
      { key: 'USA', value: 'USA' }
    ]);
  });

  it('should handle empty mappedStates', () => {
    mockClaimantsWeatherAlertsService.getClaimantInfo.and.returnValue(
      of({
        country: 'USA',
        state: 'CA',
        mappedCountries: ['USA'],
        mappedStates: null
      })
    );
    
    component.countryStateChange();
    expect(component.states).toEqual([
      { key: 'CA', value: 'CA' }
    ]);
  });
});
